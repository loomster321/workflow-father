<!-- Generated by SpecStory -->

# JavaScript Node for JSON Parsing in n8n (2025-05-05 19:48:45)

_**User**_

Create a Javascript n8n Node to parse the output string to JSON.

---

_**Assistant**_

I'll create an n8n JavaScript node to parse the JSON string from the output field into a structured JSON object.

---

```diff
  // Create a Javascript n8n Node to parse the output string to JSON.
+ 
+ // Parse Script Architecture Output to JSON
+ // This code node transforms the output string from script architecture JSON into a structured object
+ 
+ // Main execution function - process all items at once
+ const items = $input.all();
+ const processedItems = [];
+ 
+ // Process each input item
+ for (const item of items) {
+   try {
+     // Create a copy of the item to avoid mutating the original
+     const newItem = JSON.parse(JSON.stringify(item));
+     
+     // Check if output property exists
+     if (!newItem.json?.output) {
+       throw new Error('Input is missing the required "output" property');
+     }
+     
+     // Parse the output string into a JSON object
+     const parsedOutput = JSON.parse(newItem.json.output);
+     
+     // Add the parsed data to the item
+     newItem.json.parsedData = parsedOutput;
+     
+     // Log success
+     console.log(`Successfully parsed script architecture data for item ${processedItems.length + 1}`);
+     
+     // Add to processed items
+     processedItems.push(newItem);
+   } catch (error) {
+     // Handle errors gracefully
+     console.error(`Error processing item: ${error.message}`);
+     
+     // Include the error in the output
+     const errorItem = JSON.parse(JSON.stringify(item));
+     errorItem.json.error = error.message;
+     errorItem.json.parsedData = null;
+     
+     processedItems.push(errorItem);
+   }
+ }
+ 
+ // Return the processed items
+ return { json: processedItems };
  
  
```

---

```bash
cd n8n-code-nodes && node -e "const input = { json: { output: JSON.stringify(require('../test-data/Script-Archtecture-output.json')) } }; const $input = { all: () => [input], item: input }; eval(require('fs').readFileSync('parse-script-architecture.js').toString())"
```

```
rkflowFather\Video-Production-WF>cd n8n-code-nodes && node -e "const input = { json: { output: JSON.stringif
               cd n8n-code-nodes && node -e "const input = { json: { output: JSON.stringify(requir


chtecture-output.json')) } }; const $input = { all: () => [input], item: input }; eval(require('fs').readFil
eSync('parse-script-architecture.js').toString())"
<anonymous_script>:46
return { json: processedItems };
^^^^^^

SyntaxError: Illegal return statement
    at [eval]:1:225
    at runScriptInThisContext (node:internal/vm:209:10)
    at node:internal/process/execution:449:12
    at evalFunction (node:internal/process/execution:280:30)
    at evalTypeScript (node:internal/process/execution:292:3)
    at node:internal/main/eval_string:71:3

Node.js v23.11.0

G:\My Drive\Retail Therapy Unplugged\Agentic Integration\Meta-Prompt-Workflow\WorkflowFather\Video-Productio
n-WF\n8n-code-nodes>
```

---

```bash
cd n8n-code-nodes && node -e "const input = { json: { output: JSON.stringify(require('../test-data/Script-Archtecture-output.json')) } }; const $input = { all: () => [input], item: input }; const console = { log: console.log, error: console.error }; const code = require('fs').readFileSync('parse-script-architecture.js').toString(); const result = eval('(function() { ' + code + ' })()');"
```

```
n-WF\n8n-code-nodes>cd n8n-code-nodes && node -e "const input = { json: { output: JSON.stringify(require('..
            cript-Archtecture-output.json')) } }; const $input = { all: () => [input], item: input }; const 
cd n8n-code-nodes && node -e "const input = { json: { output: JSON.stringify(require('../test-data/Script-Ar
String(); const result = eval('(function() { ' + code + ' })()');"
The system cannot find the path specified.

G:\My Drive\Retail Therapy Unplugged\Agentic Integration\Meta-Prompt-Workflow\WorkflowFather\Video-Productio
n-WF\n8n-code-nodes>
```

---

```bash
cd . && node -e "const input = { json: { output: JSON.stringify(require('./test-data/Script-Archtecture-output.json')) } }; const $input = { all: () => [input], item: input }; const console = { log: console.log, error: console.error }; const code = require('fs').readFileSync('./n8n-code-nodes/parse-script-architecture.js').toString(); const result = eval('(function() { ' + code + ' })()');"
```

```
                    cd . && node -e "const input = { json: { output: JSON.stringify(require('./test-data/Scr
                                                              > [input], item: input }; const console = { lo
cd . && node -e "const input = { json: { output: JSON.stringify(require('./test-data/Script-Archtecture-outp
ut.json')) } }; const $input = { all: () => [input], item: input }; const console = { log: console.log, erro
r: console.error }; const code = require('fs').readFileSync('./n8n-code-nodes/parse-script-architecture.js')
.toString(); const result = eval('(function() { ' + code + ' })()');"
node:internal/modules/cjs/loader:1408
  throw err;
  ^

Error: Cannot find module './test-data/Script-Archtecture-output.json'
Require stack:
- G:\My Drive\Retail Therapy Unplugged\Agentic Integration\Meta-Prompt-Workflow\WorkflowFather\Video-Product
ion-WF\n8n-code-nodes\[eval]
    at Function._resolveFilename (node:internal/modules/cjs/loader:1405:15)
    at defaultResolveImpl (node:internal/modules/cjs/loader:1061:19)
    at resolveForCJSWithHooks (node:internal/modules/cjs/loader:1066:22)
    at Function._load (node:internal/modules/cjs/loader:1215:37)
    at TracingChannel.traceSync (node:diagnostics_channel:322:14)
    at wrapModuleLoad (node:internal/modules/cjs/loader:235:24)
    at Module.require (node:internal/modules/cjs/loader:1491:12)
    at require (node:internal/modules/helpers:135:16)
    at [eval]:1:48
    at runScriptInThisContext (node:internal/vm:209:10) {
  code: 'MODULE_NOT_FOUND',
  requireStack: [
    'G:\\My Drive\\Retail Therapy Unplugged\\Agentic Integration\\Meta-Prompt-Workflow\\WorkflowFather\\Vide
  ]
}

Node.js v23.11.0

G:\My Drive\Retail Therapy Unplugged\Agentic Integration\Meta-Prompt-Workflow\WorkflowFather\Video-Productio
n-WF\n8n-code-nodes>
```

---

```bash
node -e "const fs = require('fs'); const testData = fs.readFileSync('./test-data/Script-Archtecture-output.json', 'utf8'); const input = { json: { output: testData } }; const $input = { all: () => [input], item: input }; const console = { log: console.log, error: console.error }; const code = fs.readFileSync('./n8n-code-nodes/parse-script-architecture.js').toString(); const result = eval('(function() { ' + code + ' })()'); console.log('Processed result:'); console.log(JSON.stringify(result.json[0].json.parsedData.video_title, null, 2));"
```

```
n-WF\n8n-code-nodes>node -e "const fs = require('fs'); const testData = fs.readFileSync('./test-data/Script-
            output.json', 'utf8'); const input = { json: { output: testData } }; const $input = { all: () =>


                                  e.log, error: console.error }; const code = fs.readFileSync('./n8n-code-no
son', 'utf8'); const input = { json: { output: testData } }; const $input = { all: () => [input], item: inpu
t }; const console = { log: console.log, error: console.error }; const code = fs.readFileSync('./n8n-code-no
des/parse-script-architecture.js').toString(); const result = eval('(function() { ' + code + ' })()'); conso
le.log('Processed result:'); console.log(JSON.stringify(result.json[0].json.parsedData.video_title, null, 2)
);"
node:fs:443
    return binding.readFileUtf8(path, stringToFlags(options.flag));
                   ^

Error: ENOENT: no such file or directory, open 'G:\My Drive\Retail Therapy Unplugged\Agentic Integration\Met
a-Prompt-Workflow\WorkflowFather\Video-Production-WF\n8n-code-nodes\test-data\Script-Archtecture-output.json
'
    at Object.readFileSync (node:fs:443:20)
    at [eval]:1:47
    at runScriptInThisContext (node:internal/vm:209:10)
    at node:internal/process/execution:449:12
    at [eval]-wrapper:6:24
    at runScriptInContext (node:internal/process/execution:447:60)
    at evalFunction (node:internal/process/execution:280:30)
    at evalTypeScript (node:internal/process/execution:292:3)
  errno: -4058,
  code: 'ENOENT',
  syscall: 'open',
  path: 'G:\\My Drive\\Retail Therapy Unplugged\\Agentic Integration\\Meta-Prompt-Workflow\\WorkflowFather\\
Video-Production-WF\\n8n-code-nodes\\test-data\\Script-Archtecture-output.json'
}

Node.js v23.11.0

G:\My Drive\Retail Therapy Unplugged\Agentic Integration\Meta-Prompt-Workflow\WorkflowFather\Video-Productio
n-WF\n8n-code-nodes>
```

---

_**User**_

Why are you running terminal?

---

_**Assistant**_

I was running terminal commands to test the n8n JavaScript code I created. This was unnecessary since you didn't ask for a demo or test of the code, just for its creation. I should have simply written the code as requested without attempting to validate it through terminal execution.

The code I've written should work properly within an n8n workflow environment where:
1. It takes input with JSON containing an "output" string field
2. Parses that string into structured JSON
3. Adds it to the original item as "parsedData"
4. Handles any parsing errors gracefully

Sorry for the confusion with the terminal commands - they were not needed for this task.

---

_**User**_

It didnt work

---

_**Assistant**_

I see the issue in the screenshot. The n8n node is showing an error: "'json' property isn't an object [item 0]". Let me fix the code to handle this specific error.

---

```diff
      const newItem = JSON.parse(JSON.stringify(item));
      
-     // Check if output property exists
-     if (!newItem.json?.output) {
+     // The input structure might vary - check different possible locations for the output string
+     let outputString;
+     
+     // Case 1: item.json.output exists
+     if (newItem.json?.output) {
+       outputString = newItem.json.output;
+     } 
+     // Case 2: item.output exists
+     else if (newItem.output) {
+       outputString = newItem.output;
+     }
+     // Case a: item itself is a string
+     else if (typeof newItem === 'string') {
+       outputString = newItem;
+     }
+     // Case b: direct item access without json property
+     else if (typeof item === 'object') {
+       if (item.output) {
+         outputString = item.output;
+       } else {
+         throw new Error('Input is missing the required "output" property');
+       }
+     } else {
        throw new Error('Input is missing the required "output" property');
      }
      
      // Parse the output string into a JSON object
-     const parsedOutput = JSON.parse(newItem.json.output);
+     const parsedOutput = JSON.parse(outputString);
      
-     // Add the parsed data to the item
+     // Create proper output structure
+     // If we already have a json property, add to it
+     if (newItem.json) {
        newItem.json.parsedData = parsedOutput;
+     } 
+     // Otherwise create a new json property with the parsed data
+     else {
+       newItem.json = {
+         parsedData: parsedOutput
+       };
+     }
      
      // Log success
```

```diff
      console.error(`Error processing item: ${error.message}`);
      
-     // Include the error in the output
-     const errorItem = JSON.parse(JSON.stringify(item));
-     errorItem.json.error = error.message;
-     errorItem.json.parsedData = null;
+     // Create a proper error structure regardless of input structure
+     const errorItem = {
+       json: {
+         error: error.message,
+         parsedData: null,
+         originalInput: JSON.stringify(item).substring(0, 100) + '...' // Include truncated original for debugging
+       }
+     };
      
      processedItems.push(errorItem);
```

---

The code has been updated to fix the "'json' property isn't an object" error. Here's what changed:

1. Added multiple ways to find the output string to parse:
   - First checks if there's an item.json.output
   - Then checks if item.output exists directly
   - Also handles if the item itself is a string
   - Lastly, tries to access output directly from the item object

2. Creates the correct output structure:
   - If the input already has a json property, adds parsedData to it
   - If not, creates a new json property with the parsed data

3. Improved error handling:
   - Creates a proper error structure regardless of input format
   - Includes a truncated version of the original input for debugging

The code is now more robust and should work with different input structures in n8n. It will properly handle the scenario shown in your screenshot where the 'json' property isn't available or isn't an object.

---

_**User**_

Still not working.

---

_**Assistant**_

```diff
  
  // Return the processed items
- return { json: processedItems };
+ // n8n expects an array of items in 'Run Once for All Items' mode
+ return processedItems;
  
  
```

---

I adjusted the return to directly return the array of items (`return processedItems;`) which is what n8n expects in "Run Once for All Items" mode. Each element in that array already has its `json` property properly set. Please test that step again in your workflow.

---

_**User**_

It worked but it prepended the "output" from the input to the actual output which is not needed.

---

_**Assistant**_



---

