flowchart TD
%% Documents using speech bubble style nodes
A>"Video Script"]:::document ---> B
B[Scene Segmentation]:::aiAgent ---> B1
B1[Scene Metrics Calculator]:::integration ---> C
C>"Scene Blueprint"]:::document ---> D
C ---> Z
C ---> P
C ---> BM
D[Shot Segmentation]:::aiAgent ---> D1
D1[Shot Metrics Calculator]:::integration ---> E
E>"Shot Plan"]:::document ---> F
E ---> P
E -.-> SE

subgraph "B-Roll Production"
F[B-Roll Ideation]:::aiAgent ---> G
G>"B-Roll Concepts"]:::document ---> H1
H1[Visual Narrative Design]:::aiAgent ---> VN_Code
VN_Code[Visual Narrative Processor]:::integration ---> G1
G1>"Visual Narrative"]:::document ---> H
G1 -.-> SE
G1 -.-> H2

%% Character reference image selection happens early
Z[Character Reference Selection]:::humanInLoop ---> Z1
Z1>"Character References"]:::document -.-> H

H[MidJourney Prompt Engineering]:::aiAgent ---> I
I>"Image Prompts"]:::document ---> J
J[Image Generation]:::integration ---> K
K>"Generated Images"]:::document ---> L
L[Image Review]:::humanInLoop ---> M
M>"Approved Images"]:::document ---> H2
M -.-> N

%% Feedback loop from Image Review to MidJourney Prompt Engineering
L -- "Rejected with Feedback" --> H

%% Kling prompt engineering references Visual Narrative for context
H2[Kling Prompt Engineering]:::aiAgent ---> I2
I2>"Animation Prompts"]:::document ---> N
N[Image-to-Video Conversion]:::integration ---> O
O>"Animated Clips"]:::document ---> R
end

subgraph "A-Roll Production"
P[Audio Generation]:::integration ---> Q
Q>"Narration Audio"]:::document ---> R
Q ---> AM
end

subgraph "Audio Production"
BM[Music Selection]:::aiAgent ---> BMO
BMO>"Music Plan"]:::document ---> AM

%% Sound Effects Generation references both Shot Plan and Visual Narrative
SE[Sound Effects Generation]:::aiAgent ---> SEO
SEO>"SFX Plan"]:::document ---> AM

AM[Audio Mixing]:::integration ---> AMO
AMO>"Final Audio"]:::document ---> R
end

subgraph "Post-Production"
R[Timeline Assembly]:::integration ---> S
S>"Edit Assembly"]:::document ---> T
T[Final Editing & Assembly]:::humanInLoop ---> U
U>"Final Video"]:::document
end

%% Dotted lines represent n8n data references without direct connections
classDef reference stroke-dasharray: 5 5

%% Class definitions
classDef aiAgent fill:#c9e4de,stroke:#000,stroke-width:1px
classDef integration fill:#bde0fe,stroke:#000,stroke-width:1px
classDef humanInLoop fill:#ffcfd2,stroke:#000,stroke-width:1px
classDef document fill:#f1f1f1,stroke:#000,stroke-width:1px 